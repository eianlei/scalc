<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="index.css">
<style>
    /* (A1) FLEXIBLE CONTAINER */
    .wrap-flex {
      display: flex;
      width: 100%;
      /* OPTIONAL ALIGNMENT: flex-start | flex-end | center | baseline | stretch */
      align-items: baseline;
    }
     
    /* (A2) NOT IMPORTANT, JUST TO BETTER SHOW HOW ALIGN-ITEMS WORK 
    .wrap-flex > * {
      border: 1px solid red;
      width: 33%; 
    } */

    /* this will align the main and animated text layers canvases over each other */
    .div_bProf {
        position: relative;
        width: 600px;
        height: 210px;
    }
    .div_bProf canvas {
        position: absolute;
        top: 0;
        left: 0;
    }
</style>


<h1>Gas Blender</h1>
<div id="blender_main">
    <p>Calculate gas blending instructions by changing any input control. 
        The new instruction will print automatically.</p>
    <div class="wrap-flex">
        <p><b>Blending method selection: </b></p>

        <select id ="ddl_ft" name="ddl_ft" class="ddl" onmousedown="this.value='';"" value="air">
        <option value='air'>plain air fill</option>
        <option value='nx'>Nitrox CFM</option>
        <option value='tmx'>Trimix CFM</option>
        <option value='pp' selected="pp">Partial Pressure</option>
        <option value='cfm'>Helium + Nitrox CFM</option>
        <option value='top' disabled>He + O2 + topoff gas</option>
        </select>
    </div>
    <div>
        <button onclick="openCost()">Cost of this fill</button>
        <button onclick="openSources()">Gas Sources</button>
    </div>
    <table class="t2">
        <tr>
            <td><b>Current tank mix</b></td>
            <td>
                <select id ="dd_startGas" name="dd_wantedGas" class="ddl" onmousedown="this.value='';"" >
                    <option value='21/0'>air</option>
                    <option value='28/0'>EAN 28%</option>
                    <option value='32/0'>EAN 32%</option>
                    <option value='30/30'>TMX 30/30</option>
                    <option value='21/35' selected="selected">TMX 21/35</option>
                    <option value='18/45'>TMX 18/45</option>
                    <option value='15/55'>TMX 15/55</option> 
                    <option value='12/65'>TMX 12/65</option>
                    <option value='10/70'>TMX 10/70</option> 
                    <option value='50/0'>EAN 50%</option>
                    <option value='100/0'>EAN 100%</option>
                </select>          
            </td>
        </tr>
        <tr>
            <td>Current tank pressure (bar)</td>
            <td><input type="number" min=1 max=300 step=1 class="input2" value="100" id="start_bar"/></td>
            <td><button onclick="emptyTank()">EMPTY</button></td>
        </tr>
        <tr>
            <td>Current Oxygen (%)</td>
            <td><input type="number" min=10 max=100 step=1 class="input2" value="21" id="start_o2_pct"/></td>
        </tr>
        <tr>
            <td>Current Helium (%)</td>
            <td><input type="number" min=0 max=100 step=1 class="input2" value="35" id="start_he_pct"/></td>
        </tr>
    </table>
    <hr>
    <table class="t2">
        <tr>
            <td><b>Wanted tank mix</b></td>
            <td>
                <select id ="dd_wantedGas" name="dd_wantedGas" class="ddl" onmousedown="this.value='';"" >
                    <option value='21/0'>air</option>
                    <option value='28/0'>EAN 28%</option>
                    <option value='32/0'>EAN 32%</option>
                    <option value='30/30'>TMX 30/30</option>
                    <option value='21/35' selected="selected">TMX 21/35</option>
                    <option value='18/45'>TMX 18/45</option>
                    <option value='15/55'>TMX 15/55</option> 
                    <option value='12/65'>TMX 12/65</option>
                    <option value='10/70'>TMX 10/70</option> 
                    <option value='50/0'>EAN 50%</option>
                    <option value='100/0'>Oxygen</option>
                </select>          
            </td>
        </tr>
        <tr>
            <td>Wanted tank pressure (bar)</td>
            <td><input type="number" min=1 max=300 step=1 class="input2" value="200" id="end_bar"/></td>
            <td>
                <select id ="dd_end_bar" name="dd_end_bar" class="ddl" onmousedown="this.value='';"" >
                    <option value='200' selected="selected">200</option>
                    <option value='232'>232</option>
                    <option value='300'>300</option>
                </select>
            </td>
        </tr>
        <tr>
            <td>Wanted Oxygen (%)</td>
            <td><input type="number" min=10 max=100 step=1 class="input2" value="21" id="end_o2_pct"/></td>
        </tr>
        <tr>
            <td>Wanted Helium (%)</td>
            <td><input type="number" min=0 max=100 step=1 class="input2" value="35" id="end_he_pct"/></td>
        </tr>
    </table>

    <textarea id="text_output" name="text_output" cols="80" rows="10" >
        this is where the calculation output prints
    </textarea>
</div> <!-- main-->

<!-- cost calculation panel -->
<div id="blender_cost" style="display: none;">
    <h2>Cost calculation of the gas fill</h2>
    <button onclick="back2blender()">BACK</button>
    <table class="t2">
        <tr>
            <td>tank size (liters) </td>
            <td><input type="number" min=1 max=50 step=1 class="in_cost" value="24" id="tank_liters"/></td>
        </tr>
        <tr>
            <td>Oxygen price (EUR/m<sup>3</sup>) </td>
            <td><input type="number" min=1 max=50 step=0.1 class="in_cost" value="4.6" id="o2_price"/></td>
        </tr>
        <tr>
            <td>Helium price (EUR/m<sup>3</sup></td>
            <td><input type="number" min=10 max=200 step=0.1 class="in_cost" value="35" id="he_price"/></td>
        </tr>
        <tr>
            <td>compressor run (&euro;) </td>
            <td><input type="number" min=1 max=50 step=1 class="in_cost" value="6" id="c_price"/></td>
        </tr>
    </table>
    <textarea id="cost_output" name="cost_output" cols="80" rows="10" >
        this is where the cost calculation output prints
    </textarea>
</div>


<div class="div_bProf">

    <canvas id="bProfCanvas" width="600" height="210" style="border:1px solid #000000;"></canvas>
    <canvas id="pProfCanvas_txt" width="600" height="210" style="border:1px solid #000000;"></canvas>
</div>


<!--
<script src="../node_modules/jquery/dist/jquery.min.js" type="text/javascript"></script>
-->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="./tmxcalc.js"></script>
<script>
    let global_result;
    var filltype = "pp";
    // always run the whole show once with defaults
    calculateBlend();

    function openCost(){
        document.getElementById("blender_cost").style.display = "block";
        document.getElementById("blender_main").style.display = "none";
        doCost();
    };
    function doCost(){
        let liters = parseInt($("#tank_liters").val());
        let o2_price_eur = parseInt($("#o2_price").val());
        let he_price_eur = parseInt($("#he_price").val());
        let fill_price_eur = parseInt($("#c_price").val());
        let txt;
        let total_cost;
        [total_cost, txt] = calculateCost(liters, 
        fill_bar = parseInt($('#end_bar').val()), 
        global_result.add_o2, 
        global_result.add_he, 
        o2_price_eur, he_price_eur, fill_price_eur);
        $("#cost_output").val(txt);    
    };
    function back2blender(){
        document.getElementById("blender_cost").style.display = "none";
        document.getElementById("blender_main").style.display = "block";
    };


    function calculateBlend()
    {
        let start_bar =    parseInt($("#start_bar").val());
        let end_bar =      parseInt($('#end_bar').val());
        let start_o2_pct = parseInt($('#start_o2_pct').val());
        let start_he_pct = parseInt($('#start_he_pct').val());
        let end_o2_pct =   parseInt($('#end_o2_pct').val());
        let end_he_pct =   parseInt($('#end_he_pct').val());
        // filltype = "pp";
        // filltype = $("#ddl_ft").val;
   
        let deb_txt =  `calculateBlend ${start_bar} ${end_bar} ${start_o2_pct} ${start_he_pct} ${end_o2_pct} ${end_he_pct}`;
        console.log(filltype);
        // $("#text_output").val(deb_txt);
        let result = tmxcalc_num(filltype, start_bar, start_o2_pct, start_he_pct, 
                end_bar, end_o2_pct, end_he_pct, false, false);
        global_result = result;
        if (result.status_code == 0) {
           result_txt = tmxcalc_text(result);
           $("#text_output").val(result_txt);
        }
        else {
            $("#text_output").val(result.status_txt);
        }
        drawFillProfile(result);

    }

  // this is called when any class input2 element changes
  $(function()
  {
      $(".input2").on("change",calculateBlend)
  })

  $(function()
  {
      $(".in_cost").on("change",doCost)
  })

  // dropdown menu for ft filltype selection
  $("#ddl_ft").change(function () {
   dropval = $(this).val();
   console.log(`ddl_ft ${dropval} `);
   filltype = dropval;
   calculateBlend();
  });

  // dropdown menu for start gas  
  $("#dd_startGas").change(function () {
    var dropTxt = $(this).val();
    var gases = dropTxt.split('/');
    $("#start_o2_pct").val(gases[0]);
    $("#start_he_pct").val(gases[1]);
    calculateBlend();
  });

    // dropdown menu for wanted gas  
    $("#dd_wantedGas").change(function () {
    var dropTxt = $(this).val();
    var gases = dropTxt.split('/');
    $("#end_o2_pct").val(gases[0]);
    $("#end_he_pct").val(gases[1]);
    calculateBlend();
  });

    // dropdown menu for end_bar  
    $("#dd_end_bar").change(function () {
    var dropTxt = $(this).val();
    $("#end_bar").val(parseInt(dropTxt) );

    calculateBlend();
  });

  // from button EMPTY tank
  function emptyTank(){
    $("#start_bar").val(1);
    $("#start_o2_pct").val(21);
    $("#start_he_pct").val(0);
    $("#dd_startGas").val("21/0");
    calculateBlend();
  };

  function calculateCost(
    liters, fill_bar, add_o2, add_he, o2_cost_eur, he_cost_eur, fill_cost_eur)
    {
        // cost calculation
        let o2_lit = liters * fill_bar * (add_o2 / fill_bar);
        let he_lit = liters * fill_bar * (add_he / fill_bar);
        let o2_eur = o2_lit * o2_cost_eur / 1000;
        let he_eur = he_lit * he_cost_eur / 1000;
        let total_cost = fill_cost_eur + o2_eur + he_eur;
        let txt = 
            "Total cost of the fill is:\n"+
            `${total_cost.toFixed(2)} EUR\n`+
            `- ${o2_lit.toFixed(0)} liters Oxygen costing ${o2_eur.toFixed(2)} EUR\n`+
            `- ${he_lit.toFixed(0)} liters Helium costing ${he_eur.toFixed(2)} EUR\n`+ 
            `- cfm/air fill costing ${fill_cost_eur.toFixed(2)} EUR\n`;
        // return the results
        return [total_cost, txt];
    }

/**
 * 
*/
function drawFillProfile(result){
    var c = document.getElementById("bProfCanvas");
    var cTXT = document.getElementById("pProfCanvas_txt");
    let pw = c.width -50;
    let ph = c.height -15
    var ctx = c.getContext("2d");
    var ctxTXT = cTXT.getContext("2d");
    ctx.font = '9px Arial';
        
    // clear out previous plots
    ctx.clearRect(0,0, c.width, c.height);

    var tx =     [ 0 , 30, 70,100,170,200,270,300]; 
    var barTot = [ 80, 80,100,100,140,140,200,200];

    // total pressures at different fill phases
    barTot[0] = result.start_bar_in;
    barTot[1] = barTot[0];
    barTot[2] = result.tbar_2;
    barTot[3] = barTot[2];
    barTot[4] = result.tbar_3;
    barTot[5] = barTot[4];
    barTot[6] = result.stop_bar_in;
    barTot[7] = barTot[6];

    // Helium pressures from total down at different fill phases
    var b2 = Array(8);
    b2[0] = result.start_bar_in * (100-result.start_he_in)/100;
    b2[1] = b2[0];
    b2[2] = result.tbar_2 * (100-result.t2_he_pct)/100;
    b2[3] = b2[2];
    b2[4] = result.tbar_3 * (100-result.t3_he_pct)/100;;
    b2[5] = b2[4];
    b2[6] = result.stop_bar_in * (100-result.mix_he_pct)/100;
    b2[7] = b2[6];

    // Oxygen pressures from bottom up at different fill phases
    var b3 = Array(8);
    b3[0] = result.start_bar_in * (result.start_o2_in)/100;
    b3[1] = b3[0];
    b3[2] = result.tbar_2 * (result.t2_o2_pct)/100;
    b3[3] = b3[2];
    b3[4] = result.tbar_3 * (result.t3_o2_pct)/100;;
    b3[5] = b3[4];
    b3[6] = result.stop_bar_in * (result.mix_o2_pct)/100;
    b3[7] = b3[6];

    // draw gas fill plot
    // first the total, with Helium color fill
    drawRamp(ctx, "Coral", tx, barTot);
    //var b2 = barTot.map(function(e){return e * 0.8;});
    // then Nitrogen
    drawRamp(ctx, "LightBlue", tx, b2);
    // finally Oxygen
    //var b3 = barTot.map(function(e){return e * 0.2;});
    drawRamp(ctx, "cyan", tx, b3);
    
    drawVertLines(ctx, tx);

    ctx.beginPath();
    ctx.fillStyle = "black";

    [0, 2, 4, 6].forEach( i => {
        ctx.fillText(`${barTot[i].toFixed(0)} bar`, tx[i]+2, 208-barTot[i]);
    });
    [[1, "He", result.add_he], 
     [3, "O2", result.add_o2], 
     [5, "air", result.add_air]].forEach( i => {
        ctx.fillText(`add ${i[1]}`, tx[i[0]]+2, 15);
        ctx.fillText(`${i[2].toFixed(1)}`, tx[i[0]]+2, 25);
    });

    

    ctx.stroke();
}    

function drawRamp(ctx, color, tx, bar_arr){
    var x = 0 ;
    var y = 0;
    ctx.beginPath();
    ctx.moveTo(0, 0);
    for (var i=0; i< tx.length; i++){
        x = tx[i];
        y = 210 - bar_arr[i];
        ctx.lineTo(x, y);
        //ctx.fillText(`${bar_arr[i]}`, x, y);
    }
    ctx.lineTo(x, 210);
    ctx.lineTo(0, 210);
    ctx.lineTo(0, 0);
    ctx.closePath();
    ctx.lineWidth = 1;
    ctx.fillStyle = color;
    ctx.fill();
    ctx.strokeStyle = "black";
    ctx.stroke();
    ctx.closePath();
}

function drawVertLines(ctx, tx){
    var x = 0 ;
    var y = 0;
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineWidth = 1;
    ctx.strokeStyle = "black";

    for (var i=0; i< tx.length; i++){
        x = tx[i];
        ctx.moveTo(x, 0);
        ctx.lineTo(x, 210);
        ctx.stroke();
    }
    ctx.stroke();
    ctx.closePath();
}

</script>