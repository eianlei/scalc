<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="index.css">

<style>
    body {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 12px;
    }
    
    .sidenav {
      height: 100%;
      width: 0;
      position: fixed;
      z-index: 1;
      top: 0;
      left: 0;
      background-color: #111;
      overflow-x: hidden;
      transition: 0.5s;
      padding-top: 60px;
    }
    
    .sidenav a {
      padding: 8px 8px 8px 32px;
      text-decoration: none;
      font-size: 14px;
      color: #818181;
      display: block;
      transition: 0.3s;
    }
    
    .sidenav a:hover {
      color: #f1f1f1;
    }
    
    .sidenav .closebtn {
      position: absolute;
      top: 0;
      right: 25px;
      font-size: 36px;
      margin-left: 50px;
    }
    
    #main {
      transition: margin-left .5s;
      padding: 16px;
    }
    
    @media screen and (max-height: 450px) {
      .sidenav {padding-top: 15px;}
      .sidenav a {font-size: 18px;}


    }
    .pTable tr:nth-child(even) {background-color: #f2f2f2;}
    .pTable tr:hover {background-color: #ddd;}

    /* this will align the main and animated text layers canvases over each other */
    .profile2 {
        position: relative;
        width: 600px;
        height: 200px;
    }
    .profile2 canvas {
        position: absolute;
        top: 0;
        left: 0;
    }
</style>
</head>
<body>
    
    <div id="mySidenav" class="sidenav">
      <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
      <a href="#">Controls</a>
      <a href="#">Profile</a>
      <a href="planner_table.html" target="_blank">Table</a>
      <a href="#">Debug</a>
    </div>
    
<div id="main">

    <h1>Dive Planner Prototype (not suitable for real dives)</h1>
    <p>
    This form calculates a dive plan for a simple profile using the 
    <a href="https://en.wikipedia.org/wiki/B%C3%BChlmann_decompression_algorithm" target="_blank">BÃ¼hlmann algorithm</a> ZHL-16C
    with configurable <a href="https://gue.com/blog/gradient-factors-in-a-post-deep-stops-world/" target="_blank">gradient factors</a>. 
    This is an experimental implementation for educational use only. 
    <b>Do not use for planning real dives!</b>
    </p>
    <h4> Dive bottom time and depth, Gradient Factors</h4>
    <table class="t1">
        <tr>
            <td>depth (m)</td>
            <td title="bottom depth of dive in meters"><input type="number" min=6 max=70 class="input3" value="50"  id="dive_depth"/></td>
            <td>time (min)</td>
            <td title="bottom time in minutes"><input type="number" min=6 max=100 class="input3" value="30"  id="dive_bottom_time"/></td>
        </tr>
        <tr>
            <td>GF low (%)</td>
            <td title="Gradient Factor LOW"><input type="number" min=6 max=100 class="input3" value="30"  id="gf_low"/></td>
            <td>GF high (%)</td>
            <td title="Gradient Factor HIGH"><input type="number" min=6 max=100 class="input3" value="80"  id="gf_high"/></td>
            <td title="common GF settings">
                <select id ="dd_gf" name="dd_gf" class="ddl" onmousedown="this.value='';"" >
                    <option value='30/85'>30/85</option>
                    <option value='35/75'>35/75</option>
                    <option value='40/85'>40/85</option>
                    <option value='45/75'>45/75</option>
                    <option value='100/100'>100/100</option>
                </select>
            </td>
        </tr>
    </table>
    <h4>Specify your tanks and gases for the dive</h4>
    <table class="t1">
        <tr>
            <th title="configure the tanks/gases for the dive">tank</th>
            <th title="select which deco tanks to use or not">used</th>
            <th>O2%</th>
            <th>He%</th>
            <th>start bar</th>
            <th>liters</th>
            <th>switch (m)</th>
            <th>SAC (l/min)</th>
        </tr>
        <tr>
            <td title="bottom gas">bottom</td>
            <td title="select a standard gas from dropdown list">
                <select id ="dd_bGas" name="dd_bGas" class="ddl" onmousedown="this.value='';"" >
                    <option value='21/0'>air</option>
                    <option value='28/0'>EAN 28%</option>
                    <option value='32/0'>EAN 32%</option>
                    <option value='30/30'>TMX 30/30</option>
                    <option value='21/35'>TMX 21/35</option>
                    <option value='18/45'>TMX 18/45</option>
            <!--        <option value='15/55'>TMX 15/55</option>  // HYPOXIC GASES NOT SUPPORTED
                    <option value='12/65'>TMX 12/65</option>
                    <option value='10/70'>TMX 10/70</option> -->
                    <option value='50/0'>EAN 50%</option>
                    <option value='100/0'>EAN 100%</option>
                  </select>
            </td>
            <td title="bottom tank Oxygen %"><input type="number" min=18 max=100 class="input3" value="21"  id="bottom_O2"/></td>
            <td title="bottom tank Helium %"><input type="number" min=0 max=45 class="input3" value="35"  id="bottom_He"/></td>
            <td title="bottom tank pressure at start"><input type="number" min=100 max=300 class="input3" value="200"  id="bottom_bar"/></td>
            <td title="bottom tank size in liters"><input type="number" min=7 max=36 class="input3" value="24"  id="bottom_liters"/></td>
            <td>-</td>
            <td title="Surface Air Consumption in surface liters per minute"><input type="number" min=5 max=50 class="input3" value="15"  id="bottom_SAC"/></td>
        </tr>
        <tr>
            <td title="1st deco tank to deploy on ascent">deco 1</td>
            <td title="check to enable this tank"><input type="checkbox" id="tank_deco1" class="input3" name="tank_deco1" checked></td>
            <td><input type="number" min=18 max=100 class="input3" value="50"  id="deco1_O2"/></td>
            <td><input type="number" min=0 max=45 class="input3" value="0"  id="deco1_He"/></td>
            <td><input type="number" min=100 max=300 class="input3" value="200"  id="deco1_bar"/></td>
            <td><input type="number" min=7 max=36 class="input3" value="11"  id="deco1_liters"/></td>
            <td title="depth where tank change is done"><input type="number" min=0 max=90 class="input3" value="21"  id="deco1_switch"/></td>
            <td><input type="number" min=5 max=50 class="input3" value="15"  id="deco1_SAC"/></td>
        </tr>
        <tr>
            <td title="2nd deco tank to deploy on ascent">deco 2</td>
            <td><input type="checkbox" id="tank_deco2" class="input3" name="tank_deco2" checked></td>
            <td><input type="number" min=18 max=100 class="input3" value="100"  id="deco2_O2"/></td>
            <td><input type="number" min=0 max=45 class="input3" value="0"  id="deco2_He"/></td>
            <td><input type="number" min=100 max=300 class="input3" value="200"  id="deco2_bar"/></td>
            <td><input type="number" min=7 max=36 class="input3" value="7"  id="deco2_liters"/></td>
            <td><input type="number" min=0 max=90 class="input3" value="6"  id="deco2_switch"/></td>
            <td><input type="number" min=5 max=50 class="input3" value="15"  id="deco2_SAC"/></td>
        </tr>
        <tr>
            <!-- <td><button onclick="openNav()">panels</button></td> -->
            <td title="click to force calculation"><button onclick="runPlan()">calculate</button></td>  
            <td title="click to show tabular output of the calculation"><button onclick="openTable()">table</button></td>          
        </tr>
    </table>
    <!-- <button onclick="runPlan()">calculate</button> -->

    <div class="profile2">

        <canvas id="profileCanvas" width="600" height="200" style="border:1px solid #000000;"></canvas>
        <canvas id="profileCanvas_txt" width="600" height="200" style="border:1px solid #000000;"></canvas>
    </div>

    <div>
    <textarea id="planner_textout" name="planner_textout" cols="80" rows="30" >
        This is where the calculation output prints in text, after you have
        configured the dive parameters above. The results appear after changing any input value,
        or by clicking the <b>CALCULATE</b> button.
    </textarea>
    </div>
</div> <!-- main -->
<div id="table_panel" style="display: none;">
    <h1>Dive planner: table output </h1>
    <button onclick="showMain()">BACK</button>
    <div id ="planner_table"></div>
</div>
<div id="profile" style="display: none;">
    <h1>Dive planner: profile display </h1>
    <button onclick="showMain()">BACK</button>
    <div id ="profile_big"></div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="./gradient_factor.js"> </script>
<script src="./ZHL16c.js"> </script>
<script src="./model.js"> </script>
<script src="./tanks.js"> </script>
<script src="./profile_point.js"> </script>
<script src="./plan_txt.js"> </script>
<script src="./calculate_plan.js"> </script>

<script>


function showMain(){
    document.getElementById("table_panel").style.display = "none";
    document.getElementById("main").style.display = "block";
}

function openNav() {
  document.getElementById("mySidenav").style.width = "150px";
  document.getElementById("main").style.marginLeft = "150px";
}

function closeNav() {
  document.getElementById("mySidenav").style.width = "0";
  document.getElementById("main").style.marginLeft= "0";
}

function drawSmallProfile(dp){
    var c = document.getElementById("profileCanvas");
    var cTXT = document.getElementById("profileCanvas_txt");
    let pw = c.width -50;
    let ph = c.height -15
    var ctx = c.getContext("2d");
    var ctxTXT = cTXT.getContext("2d");
    let prof = dp.profileSampled;
    let profLastIndex = prof.length -1;
    let totalTime = prof[profLastIndex].time;
    let maxDepth = dp.bottomDepth;

    // draw the depth profile, fill with blue gradient
    ctx.clearRect(0,0, c.width, c.height);
    ctx.beginPath();
    ctx.moveTo(0, 0);
    for (var i =0; i< prof.length; i++){
        point = prof[i];
        var x = (point.time / totalTime) * pw;
        var y = (point.depth / maxDepth ) * ph;
        ctx.lineTo(x, y);
    }
    ctx.lineTo(0, 0);
    ctx.closePath();
    ctx.lineWidth = 1;
    // ctx.fillStyle = "#8ED6FF";
    var grd = ctx.createLinearGradient(0,0, 0, ph);
    grd.addColorStop(0, "lightBlue");
    grd.addColorStop(1, "Blue");
    ctx.fillStyle = grd;
    ctx.fill();
    ctx.strokeStyle = "blue";
    ctx.stroke();
    ctx.closePath();

    // draw time axis
    for (var tt=0; tt < totalTime; tt += 60){
        var x = tt / totalTime * pw;
        ctx.beginPath();
        ctx.moveTo(x, ph);
        ctx.lineTo(x, ph+5);
        ctx.strokeStyle = "black";
        ctx.stroke();
    } // time ticks every 1 min
    for (var tt=300; tt < totalTime; tt += 300){
        var x = tt / totalTime * pw;
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, ph-1);
        ctx.strokeStyle = "Grey";
        ctx.stroke();
        ctx.font = '8pt Arial';
        ctx.fillStyle = "black";
        ctx.fillText(`${tt / 60}`, x-5, ph+14);
    } // time gridlines every 5 min and minutes text

    // draw depth grid
    for (var dd=0; dd < maxDepth; dd += 5){
        var y = dd / maxDepth * ph;
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(pw, y);
        ctx.strokeStyle = "Green";
        ctx.stroke();
        ctx.font = '8pt Arial';
        ctx.fillStyle = "blue";
        ctx.fillText(`${dd} m`, pw+1, y+5);
    }
    ctx.stroke();

    // draw tank pressures
    var previousTank = null;
    var lastPressure = null;
    ctx.strokeStyle = "Orange";
    ctx.fillStyle = "red"
    ctx.font = '9pt Arial';
    var x1 = 0;
    var y1 = (1.0 - prof[0].tankPressure /300.0) * ph;
    ctx.beginPath();
    for (var i =0; i< prof.length; i++){
        point = prof[i];
        var thisTank = point.tank;
        var x = point.time / totalTime * pw;
        var y = (1.0 - point.tankPressure /300.0) * ph;
        if (thisTank != previousTank){
            if (lastPressure) {
                // tank/gas change at this point
                ctx.fillText(`${lastPressure.toFixed(0)} bar`, x-5, y1);
                ctx.fillText(`${previousTank.name}> ${thisTank.name}`, x-5, y1+10);
                ctx.beginPath();
                ctx.moveTo(x1, y1+5);
                ctx.lineTo(x1, y-5);
                ctx.lineWidth =4;
                ctx.strokeStyle = "red";
                ctx.stroke();
                //ctx.closePath();
            }
            ///////////ctx.strokeStyle = thisTank.color;
            // starting with new tank
            ctx.fillText(`${point.tankPressure.toFixed(0)} bar`, x+5, y)
            y1 = y;
        }
        // plot the pressure of the current tank
        ctx.strokeStyle = "Orange";
        ctx.lineWidth =1;
        ctx.moveTo(x1, y1);
        ctx.lineTo(x, y);
        ctx.stroke();
        x1 = x; y1 = y;
        previousTank = thisTank;
        lastPressure = point.tankPressure;
    } // draw tank pressures loop
    ctx.closePath();
    // print the end pressure of the last tank
    ctx.fillText(`${lastPressure.toFixed(0)}`, x-20, y-10);

    function getPointText (xMouse){
        if (xMouse > pw) {
            return ["", 0];
        }
        var mouseTime = xMouse * totalTime /pw;
        for (idx = 0; idx < prof.length; idx++){
            if (prof[idx].time >= mouseTime) break;
        }
        var pointIdx = idx;
        var mousePoint = prof[pointIdx];
        var pointTxt = `${mousePoint.depth.toFixed(0)} m, ${(mouseTime/60).toFixed(0)} min`;
        var depthY = mousePoint.depth / maxDepth * ph ;
        return [pointTxt, depthY];
    }

    // track mouse over the topmost canvas c = "profileCanvas"
    cTXT.addEventListener('mousemove', function(e){
        with(ctxTXT) {
            ctxTXT.clearRect(0,0, ctxTXT.canvas.width, ctxTXT.canvas.height);
            ctxTXT.beginPath();
            ctxTXT.font = '8pt Arial';
            ctxTXT.fillStyle = "black";
            ctxTXT.strokeStyle = "black";
            ctx.lineWidth = 1;
            //** the following function gets you canvas relative x, y
            var [xt, yt] = getCursorPosition(c, e);
            // ctxTXT.fillText(`mouse ${xt} ${yt.toFixed(1)}`, xt+2, yt);
            var pointTxt;
            var depthY;
            [pointTxt, depthY] = getPointText(xt);
            ctxTXT.fillText(pointTxt, xt+2, yt);
            ctxTXT.moveTo(xt, 0);
            ctxTXT.lineTo(xt, ctxTXT.canvas.height);
            ctxTXT.closePath();
            ctxTXT.moveTo(0, depthY);
            ctxTXT.lineTo(ctxTXT.canvas.width, depthY);
            ctxTXT.stroke();
            ctxTXT.closePath();
            this.xt2 = xt; 
            this.yt2 = yt;
            // console.log (`mouse ${xt} ${yt}`);
        }
    } ,0);

} // drawSmallProfile()

function getCursorPosition(canvas, event) {
    const rect = canvas.getBoundingClientRect()
    const x = event.clientX - rect.left
    const y = event.clientY - rect.top
    // console.log("x: " + x + " y: " + y)
    return [x, y];
} // from https://stackoverflow.com/questions/55677/how-do-i-get-the-coordinates-of-a-mouse-click-on-a-canvas-element/18053642#18053642

$(function()
{
    $(".input3").on("change",runPlan)
})   

$("#dd_bGas").change(function () {
    var dropTxt = $(this).val()
    var gases = dropTxt.split('/');
    $("#bottom_O2").val(gases[0]);
    $("#bottom_He").val(gases[1]);
    runPlan();
  });

  $("#dd_gf").change(function () {
    var dropTxt = $(this).val()
    var gfs = dropTxt.split('/');
    $("#gf_low").val(gfs[0]);
    $("#gf_high").val(gfs[1]);
    runPlan();
  });

//let myDP = new Diveplan();

var globalDP;

function runPlan()
{
    let deco1_use = $("#tank_deco1").prop("checked");
    let deco2_use = $("#tank_deco2").prop("checked");

    const myTanks = [
    { label : "BOTTOM", name: "B", use: true, 
        o2: parseInt($("#bottom_O2").val()), 
        he: parseInt($("#bottom_He").val()), 
        SAC: parseInt($("#bottom_SAC").val()), 
        ppo2max: 1.4, 
        liters: parseInt($("#bottom_liters").val()), 
        bar: parseInt($("#bottom_bar").val()), 
        pressure: 200.0, useFromTime: 0, useUntilTime: 0, 
        type: "bottom", useOrder: 1, color: "Magenta" },
    { label: "deco1", name: "D1", 
        use: deco1_use,
        o2: parseInt($("#deco1_O2").val()), 
        he: parseInt($("#deco1_He").val()), 
        changeDepth: parseInt($("#deco1_switch").val()), 
        SAC: parseInt($("#deco1_SAC").val()), 
        ppo2max: 1.6, 
        liters: parseInt($("#deco1_liters").val()), 
        bar: parseInt($("#deco1_bar").val()), 
        pressure: 200.0, useFromTime: 0, useUntilTime: 0, 
        type: "deco", useOrder: 2, color: "Cyan"},
    { label: "deco2", name: "D2", 
        use: deco2_use,
        o2: parseInt($("#deco2_O2").val()),  
        he: parseInt($("#deco2_He").val()),  
        changeDepth: parseInt($("#deco2_switch").val()), 
        SAC: parseInt($("#deco2_SAC").val()), 
        ppo2max: 1.6, 
        liters: parseInt($("#deco2_liters").val()), 
        bar: parseInt($("#deco2_bar").val()), 
        pressure: 200.0, useFromTime: 0, useUntilTime: 0, 
        type: "deco", useOrder: 3, color: "LightGray"},
    { label: "travel1", name: "T1", use: false, 
        o2: 21, he: 25, changeDepth: 40.0, SAC: 16, ppo2max: 1.4, liters: 11.0, 
        bar: 200.0, pressure: 200.0, useFromTime: 0, useUntilTime: 0, useFromTime2: 0, useUntilTime2: 0, 
        type: "travel", useOrder: 0, color: "Yellow"}
    ];

    
    const myDP = new Object();
       myDP.bottomDepth =   parseInt($("#dive_depth").val());
       myDP.bottomTime =    parseInt($("#dive_bottom_time").val()) * 60.0; // CONVERT TO SECONDS!!!!
       myDP.descTime = 3 / 60;
       myDP.ascRateToDeco = 1;
       myDP.ascRateAtDeco = 1;
       myDP.ascRateToSurface = 1;
       myDP.GFlow = parseInt($("#gf_low").val()) / 100.0; // 0.30;  //<=== fraction, not percentage!
       myDP.GFhigh = parseInt($("#gf_high").val()) / 100.0; //  0.85; //<=== fraction, not percentage!
       myDP.modelUsed = "ZHL16c";
       myDP.decoStopsCalculated = [];
       myDP.wayPoints = [];
       myDP.maxPPoxygen = 0;
       myDP.maxPPhelium = 0;
       myDP.maxPPnitrogen = 0;
       myDP.maxTCnitrogen = 0;
       myDP.maxTChelium = 0;
       myDP.ascentBegins = 0;
       myDP.changeDepth = 0;

       myDP.tankList = myTanks;
       myDP.currentTank = myTanks[0];
       myDP.nextTank = null;

       myDP.maxTCnitrogen = 0;
       myDP.maxTChelium = 0;
       myDP.profileSampled = [];
       myDP.model = [];
       myDP.tableIsGenerated = false; // controls openTable()
       
       calculatePlan(myDP);
       txt = plan_txt(myDP.decoStopsCalculated, myDP.wayPoints, myDP.tankList);
       $("#planner_textout").val(txt);
    
       globalDP = myDP;
       drawSmallProfile(myDP);
}      

function openTable(){
    document.getElementById("table_panel").style.display = "block";
    document.getElementById("main").style.display = "none";

    if (globalDP.tableIsGenerated == false) {
        // generate the table only once after calculatePlan()
        var pTable = "<table class= 'pTable'>"+
            "<th title='iteration index'>idx</th>"+
            "<th title='runtime in minutes'>min</th>"+
            "<th title='dive depth in meters'>m</th>"+
            "<th title='dive phase'>phase</th>"+
            "<th title='tank name'>T</th>"+
            "<th title='Oxygen/Helium %'>O2/He</th>"+
            "<th title='tank pressure in bar'>bar</th>"+
            "<th title='partial pressure of Oxygen'>ppO2</th>"+
            "<th title='Gradient Factor % at this depth'>GF</th>"+
            "<th title='Ceiling in 3 meter step'>C3m</th>"+
            "<th title='ceiling in meters'>Ceil</th>"+
            "<th title='margin from current depth to ceiling in meters'>marg</th>"+
            "<th title='leading tissue compartment number'>lead</th>";
        for (i=0; i<16; i++) {    
            pTable += `<th title='tissue compartment #${i} ceiling in meters'>TC${i}</th>`;
        }
        pTable += "<tr>";
        let bg_col = "white";
        for(i=0; i< globalDP.profileSampled.length; i++){
            point = globalDP.profileSampled[i];
            pTable += `<td>${i}</td>`;
            pTable += `<td>${(point.time/60).toFixed(1)}</td>`;
            pTable += `<td>${point.depth.toFixed(1)}</td>`;
            pTable += `<td>${point.divephase}</td>`;
            pTable += `<td>${point.tank.name}</td>`;    
            pTable += `<td>${point.tank.o2}/${point.tank.he}</td>`;    
            pTable += `<td>${point.tankPressure.toFixed(0)}</td>`;
            pTable += `<td>${point.ppOxygen.toFixed(2)}</td>`;
            pTable += `<td>${point.gfNow.toFixed(2)}</td>`;            
            pTable += `<td>${point.ceiling3m.toFixed(0)}</td>`;
            pTable += `<td>${point.ceiling.toFixed(1)}</td>`;
            pTable += `<td>${point.margin.toFixed(1)}</td>`;
            pTable += `<td>${point.leadTC}</td>`;
            for(tc=0; tc < point.TCm.length; tc++){
                //if (tc == point.leadTC) bg_col = "red"; else bg_col ="white";
                if (tc == point.leadTC) {
                    pTable += `<td bgcolor='red'>${point.TCm[tc].toFixed(1)}</td>`;
                }else {
                    pTable += `<td>${point.TCm[tc].toFixed(1)}</td>`;
                }
            }
            pTable += "</tr><tr>"
        }
        pTable += "</tr></table>"

        document.getElementById("planner_table").innerHTML = pTable;
        var tableElement = document.getElementById("planner_table").childNodes[0];
        tableElement.border = "1";
        tableElement.style.borderCollapse="collapse";
        tableElement.style.textAlign="right" ;
        //tableElement.style.
        globalDP.tableIsGenerated = true; // don't do it again
    }// if (globalDP.tableIsGenerated) 
}



</script>