<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="index.css">

<style>
    body {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 12px;
    }
    
    .sidenav {
      height: 100%;
      width: 0;
      position: fixed;
      z-index: 1;
      top: 0;
      left: 0;
      background-color: #111;
      overflow-x: hidden;
      transition: 0.5s;
      padding-top: 60px;
    }
    
    .sidenav a {
      padding: 8px 8px 8px 32px;
      text-decoration: none;
      font-size: 14px;
      color: #818181;
      display: block;
      transition: 0.3s;
    }
    
    .sidenav a:hover {
      color: #f1f1f1;
    }
    
    .sidenav .closebtn {
      position: absolute;
      top: 0;
      right: 25px;
      font-size: 36px;
      margin-left: 50px;
    }
    
    #main {
      transition: margin-left .5s;
      padding: 16px;
    }
    
    @media screen and (max-height: 450px) {
      .sidenav {padding-top: 15px;}
      .sidenav a {font-size: 18px;}


    }
    .pTable tr:nth-child(even) {background-color: #f2f2f2;}
    .pTable tr:hover {background-color: #ddd;}
</style>
</head>
<body>
    
    <div id="mySidenav" class="sidenav">
      <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
      <a href="#">Controls</a>
      <a href="#">Profile</a>
      <a href="planner_table.html" target="_blank">Table</a>
      <a href="#">Debug</a>
    </div>
    
<div id="main">

    <h1>Dive Planner Prototype (not suitable for real dives)</h1>
    <p>
    This form calculates a dive plan for a simple profile using the 
    <a href="https://en.wikipedia.org/wiki/B%C3%BChlmann_decompression_algorithm" target="_blank">BÃ¼hlmann algorithm</a> ZHL-16C
    with configurable <a href="https://gue.com/blog/gradient-factors-in-a-post-deep-stops-world/" target="_blank">gradient factors</a>. 
    This is an experimental implementation for educational use only. 
    <b>Do not use for planning real dives!</b>
    </p>
    <h4> Dive bottom time and depth, Gradient Factors</h4>
    <table class="t1">
        <tr>
            <td>depth (m)</td>
            <td><input type="number" min=6 max=100 class="input3" value="50"  id="dive_depth"/></td>
            <td>time (min)</td>
            <td><input type="number" min=6 max=100 class="input3" value="30"  id="dive_bottom_time"/></td>
        </tr>
        <tr>
            <td>GF low (%)</td>
            <td><input type="number" min=6 max=100 class="input3" value="30"  id="gf_low"/></td>
            <td>GF high (%)</td>
            <td><input type="number" min=6 max=100 class="input3" value="80"  id="gf_high"/></td>
        </tr>
    </table>
    <h4>Specify your tanks and gases for the dive</h4>
    <table class="t1">
        <tr>
            <th>tank</th>
            <th>used</th>
            <th>O2%</th>
            <th>He%</th>
            <th>start bar</th>
            <th>liters</th>
            <th>switch (m)</th>
            <th>SAC (l/min)</th>
        </tr>
        <tr>
            <td>bottom</td>
            <td>-</td>
            <td><input type="number" min=10 max=100 class="input3" value="21"  id="bottom_O2"/></td>
            <td><input type="number" min=0 max=90 class="input3" value="30"  id="bottom_He"/></td>
            <td><input type="number" min=100 max=300 class="input3" value="200"  id="bottom_bar"/></td>
            <td><input type="number" min=7 max=36 class="input3" value="24"  id="bottom_liters"/></td>
            <td>-</td>
            <td><input type="number" min=5 max=50 class="input3" value="15"  id="bottom_SAC"/></td>
        </tr>
        <tr>
            <td>deco 1</td>
            <td><input type="checkbox" id="tank_deco1" class="input3" name="tank_deco1" checked></td>
            <td><input type="number" min=10 max=100 class="input3" value="50"  id="deco1_O2"/></td>
            <td><input type="number" min=0 max=90 class="input3" value="0"  id="deco1_He"/></td>
            <td><input type="number" min=100 max=300 class="input3" value="200"  id="deco1_bar"/></td>
            <td><input type="number" min=7 max=36 class="input3" value="11"  id="deco1_liters"/></td>
            <td><input type="number" min=0 max=90 class="input3" value="21"  id="deco1_switch"/></td>
            <td><input type="number" min=5 max=50 class="input3" value="15"  id="deco1_SAC"/></td>
        </tr>
        <tr>
            <td>deco 2</td>
            <td><input type="checkbox" id="tank_deco2" class="input3" name="tank_deco2" checked></td>
            <td><input type="number" min=10 max=100 class="input3" value="100"  id="deco2_O2"/></td>
            <td><input type="number" min=0 max=90 class="input3" value="0"  id="deco2_He"/></td>
            <td><input type="number" min=100 max=300 class="input3" value="200"  id="deco2_bar"/></td>
            <td><input type="number" min=7 max=36 class="input3" value="7"  id="deco2_liters"/></td>
            <td><input type="number" min=0 max=90 class="input3" value="6"  id="deco2_switch"/></td>
            <td><input type="number" min=5 max=50 class="input3" value="15"  id="deco2_SAC"/></td>
        </tr>
        <tr>
            <td><button onclick="openNav()">panels</button></td>
            <td><button onclick="runPlan()">calculate</button></td>  
            <td><button onclick="openTable()">table</button></td>          
        </tr>
    </table>
    <!-- <button onclick="runPlan()">calculate</button> -->

    <div>
    <canvas id="profileCanvas" width="600" height="200" style="border:1px solid #000000;">
    </canvas>
    </div>

    <div>
    <textarea id="planner_textout" name="planner_textout" cols="80" rows="30" >
        Hello this is where the calculation output prints 
    </textarea>
    </div>
</div> <!-- main -->
<div id="table_panel" style="display: none;">
    <h1>Dive planner: table output </h1>
    <button onclick="showMain()">BACK</button>
    <div id ="planner_table"></div>
</div>
<div id="profile" style="display: none;">
    <h1>Dive planner: profile display </h1>
    <button onclick="showMain()">BACK</button>
    <div id ="profile_big"></div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="./gradient_factor.js"> </script>
<script src="./ZHL16c.js"> </script>
<script src="./model.js"> </script>
<script src="./tanks.js"> </script>
<script src="./profile_point.js"> </script>
<script src="./plan_txt.js"> </script>
<script src="./calculate_plan.js"> </script>

<script>
function showMain(){
    document.getElementById("table_panel").style.display = "none";
    document.getElementById("main").style.display = "block";
}

function openNav() {
  document.getElementById("mySidenav").style.width = "150px";
  document.getElementById("main").style.marginLeft = "150px";
}

function closeNav() {
  document.getElementById("mySidenav").style.width = "0";
  document.getElementById("main").style.marginLeft= "0";
}

function drawSmallProfile(dp){
    var c = document.getElementById("profileCanvas");
    let pw = c.width -50;
    let ph = c.height -15
    var ctx = c.getContext("2d");
    let prof = dp.profileSampled;
    let profLastIndex = prof.length -1;
    let totalTime = prof[profLastIndex].time;
    let maxDepth = dp.bottomDepth;

    // draw the depth profile, fill with blue gradient
    ctx.clearRect(0,0, c.width, c.height);
    ctx.beginPath();
    ctx.moveTo(0, 0);
    for (var i =0; i< prof.length; i++){
        point = prof[i];
        var x = (point.time / totalTime) * pw;
        var y = (point.depth / maxDepth ) * ph;
        ctx.lineTo(x, y);
    }
    ctx.lineTo(0, 0);
    ctx.closePath();
    ctx.lineWidth = 1;
    // ctx.fillStyle = "#8ED6FF";
    var grd = ctx.createLinearGradient(0,0, 0, ph);
    grd.addColorStop(0, "lightBlue");
    grd.addColorStop(1, "Blue");
    ctx.fillStyle = grd;
    ctx.fill();
    ctx.strokeStyle = "blue";
    ctx.stroke();
    ctx.closePath();

    // draw time axis
    for (var tt=0; tt < totalTime; tt += 60){
        var x = tt / totalTime * pw;
        ctx.beginPath();
        ctx.moveTo(x, ph);
        ctx.lineTo(x, ph+5);
        ctx.strokeStyle = "black";
        ctx.stroke();
    } // time ticks every 1 min
    for (var tt=300; tt < totalTime; tt += 300){
        var x = tt / totalTime * pw;
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, ph-1);
        ctx.strokeStyle = "Grey";
        ctx.stroke();
        ctx.font = '8pt Arial';
        ctx.fillStyle = "black";
        ctx.fillText(`${tt / 60}`, x-5, ph+14);
    } // time gridlines every 5 min and minutes text

    // draw depth grid
    for (var dd=0; dd < maxDepth; dd += 5){
        var y = dd / maxDepth * ph;
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(pw, y);
        ctx.strokeStyle = "Orange";
        ctx.stroke();
        ctx.font = '8pt Arial';
        ctx.fillStyle = "blue";
        ctx.fillText(`${dd}`, pw+1, y+5);
    }
    ctx.stroke();

    // draw tank pressures
    var previousTank = null;
    var lastPressure = null;
    ctx.strokeStyle = "Red";
    ctx.fillStyle = "red"
    ctx.font = '10pt Arial';
    var x1 = 0;
    var y1 = (1.0 - prof[0].tankPressure /300.0) * ph;
    for (var i =0; i< prof.length; i++){
        point = prof[i];
        var thisTank = point.tank;
        var x = point.time / totalTime * pw;
        var y = (1.0 - point.tankPressure /300.0) * ph;
        if (thisTank != previousTank){
            if (lastPressure) {
                ctx.fillText(`${lastPressure.toFixed(0)}`, x-5, y1);
            }
            //ctx.strokeStyle = thisTank.color;
            ctx.fillText(`${point.tankPressure.toFixed(0)}`, x+5, y)
            y1 = y;
        }
        ctx.moveTo(x1, y1);
        ctx.lineTo(x, y);
        ctx.stroke();
        x1 = x; y1 = y;
        previousTank = thisTank;
        lastPressure = point.tankPressure;
    } // draw tank pressures
    ctx.fillText(`${lastPressure.toFixed(0)}`, x-20, y-10);

} // drawSmallProfile()

$(function()
{
    $(".input3").on("change",runPlan)
})    

//let myDP = new Diveplan();

var globalDP;

function runPlan()
{
    let deco1_use = $("#tank_deco1").prop("checked");
    let deco2_use = $("#tank_deco2").prop("checked");

    const myTanks = [
    { label : "BOTTOM", name: "B", use: true, 
        o2: parseInt($("#bottom_O2").val()), 
        he: parseInt($("#bottom_He").val()), 
        SAC: 15, ppo2max: 1.4, liters: 24.0, 
        bar: 200.0, pressure: 200.0, useFromTime: 0, useUntilTime: 0, 
        type: "bottom", useOrder: 1, color: "Magenta" },
    { label: "deco1", name: "D1", 
        use: deco1_use,
        o2: parseInt($("#deco1_O2").val()), 
        he: parseInt($("#deco1_He").val()), 
        changeDepth: 21.0, SAC: 13, ppo2max: 1.6, liters: 7.0, 
        bar: 200.0, pressure: 200.0, useFromTime: 0, useUntilTime: 0, 
        type: "deco", useOrder: 2, color: "Cyan"},
    { label: "deco2", name: "D2", 
        use: deco2_use,
        o2: parseInt($("#deco2_O2").val()),  
        he: parseInt($("#deco2_He").val()),  
        changeDepth: 6.0, SAC: 13, ppo2max: 1.6, liters: 7.0, 
        bar: 200.0, pressure: 200.0, useFromTime: 0, useUntilTime: 0, 
        type: "deco", useOrder: 3, color: "LightGray"},
    { label: "travel1", name: "T1", use: false, 
        o2: 21, he: 25, changeDepth: 40.0, SAC: 16, ppo2max: 1.4, liters: 11.0, 
        bar: 200.0, pressure: 200.0, useFromTime: 0, useUntilTime: 0, useFromTime2: 0, useUntilTime2: 0, 
        type: "travel", useOrder: 0, color: "Yellow"}
    ];

    
    const myDP = new Object();
       myDP.bottomDepth =   parseInt($("#dive_depth").val());
       myDP.bottomTime =    parseInt($("#dive_bottom_time").val()) * 60.0; // CONVERT TO SECONDS!!!!
       myDP.descTime = 3 / 60;
       myDP.ascRateToDeco = 1;
       myDP.ascRateAtDeco = 1;
       myDP.ascRateToSurface = 1;
       myDP.GFlow = parseInt($("#gf_low").val()) / 100.0; // 0.30;  //<=== fraction, not percentage!
       myDP.GFhigh = parseInt($("#gf_high").val()) / 100.0; //  0.85; //<=== fraction, not percentage!
       myDP.modelUsed = "ZHL16c";
       myDP.decoStopsCalculated = [];
       myDP.wayPoints = [];
       myDP.maxPPoxygen = 0;
       myDP.maxPPhelium = 0;
       myDP.maxPPnitrogen = 0;
       myDP.maxTCnitrogen = 0;
       myDP.maxTChelium = 0;
       myDP.ascentBegins = 0;
       myDP.changeDepth = 0;

       myDP.tankList = myTanks;
       myDP.currentTank = myTanks[0];
       myDP.nextTank = null;

       myDP.maxTCnitrogen = 0;
       myDP.maxTChelium = 0;
       myDP.profileSampled = [];
       myDP.model = [];
       myDP.tableIsGenerated = false; // controls openTable()
       
       calculatePlan(myDP);
       txt = plan_txt(myDP.decoStopsCalculated, myDP.wayPoints, myDP.tankList);
       $("#planner_textout").val(txt);
    
       globalDP = myDP;
       drawSmallProfile(myDP);
}      

function openTable(){
    document.getElementById("table_panel").style.display = "block";
    document.getElementById("main").style.display = "none";

    if (globalDP.tableIsGenerated == false) {
        // generate the table only once after calculatePlan()
        var pTable = "<table class= 'pTable'>"+
            "<th title='iteration index'>idx</th>"+
            "<th title='runtime in minutes'>min</th>"+
            "<th title='dive depth in meters'>m</th>"+
            "<th title='dive phase'>phase</th>"+
            "<th title='tank name'>T</th>"+
            "<th title='Oxygen/Helium %'>O2/He</th>"+
            "<th title='tank pressure in bar'>bar</th>"+
            "<th title='partial pressure of Oxygen'>ppO2</th>"+
            "<th title='Gradient Factor % at this depth'>GF</th>"+
            "<th title='Ceiling in 3 meter step'>C3m</th>"+
            "<th title='ceiling in meters'>Ceil</th>"+
            "<th title='margin from current depth to ceiling in meters'>marg</th>"+
            "<th title='leading tissue compartment number'>lead</th>";
        for (i=0; i<16; i++) {    
            pTable += `<th title='tissue compartment #${i} ceiling in meters'>TC${i}</th>`;
        }
        pTable += "<tr>";
        let bg_col = "white";
        for(i=0; i< globalDP.profileSampled.length; i++){
            point = globalDP.profileSampled[i];
            pTable += `<td>${i}</td>`;
            pTable += `<td>${(point.time/60).toFixed(1)}</td>`;
            pTable += `<td>${point.depth.toFixed(1)}</td>`;
            pTable += `<td>${point.divephase}</td>`;
            pTable += `<td>${point.tank.name}</td>`;    
            pTable += `<td>${point.tank.o2}/${point.tank.he}</td>`;    
            pTable += `<td>${point.tankPressure.toFixed(0)}</td>`;
            pTable += `<td>${point.ppOxygen.toFixed(2)}</td>`;
            pTable += `<td>${point.gfNow.toFixed(2)}</td>`;            
            pTable += `<td>${point.ceiling3m.toFixed(0)}</td>`;
            pTable += `<td>${point.ceiling.toFixed(1)}</td>`;
            pTable += `<td>${point.margin.toFixed(1)}</td>`;
            pTable += `<td>${point.leadTC}</td>`;
            for(tc=0; tc < point.TCm.length; tc++){
                //if (tc == point.leadTC) bg_col = "red"; else bg_col ="white";
                if (tc == point.leadTC) {
                    pTable += `<td bgcolor='red'>${point.TCm[tc].toFixed(1)}</td>`;
                }else {
                    pTable += `<td>${point.TCm[tc].toFixed(1)}</td>`;
                }
            }
            pTable += "</tr><tr>"
        }
        pTable += "</tr></table>"

        document.getElementById("planner_table").innerHTML = pTable;
        var tableElement = document.getElementById("planner_table").childNodes[0];
        tableElement.border = "1";
        tableElement.style.borderCollapse="collapse";
        tableElement.style.textAlign="right" ;
        //tableElement.style.
        globalDP.tableIsGenerated = true; // don't do it again
    }// if (globalDP.tableIsGenerated) 
}



</script>